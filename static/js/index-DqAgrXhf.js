import{d as G,r,aE as be,H as ye,o as ke,aF as we,e as xe,u as S,i as d,M as s,v as l,A as g,t as le,x as k,aG as se,B as U,D as Ie,g as V,aH as ne,q as re,F as oe,G as Se,aI as H,aJ as Ce,aK as Me,h,n as Le,aL as Te,aM as Ve,aN as ue,aO as We,aP as Q,aQ as ie,j,C as A,y as B,w as Ne,aR as $e,_ as Ee}from"./index-CpafBiW4.js";import ce from"./menu-DFwdXKcl.js";import{_ as Ue}from"./customUser.vue_vue_type_script_setup_true_lang-Ci-cwI8V.js";import{P as De}from"./index-DtyQLxZ-.js";const Re={key:0,class:"flex mb-[10px]"},He={class:"ml-[20px]"},Ae={class:"flex items-center"},Be={key:1,class:"flex-c"},Oe={key:1,class:"flex-c w-full h-[90%]"},qe=G({name:"sandbox",__name:"index",setup(ze){const O=r(null),p=be(),C=r(window.innerWidth<992),q=r(window.innerWidth<768),X=r(window.innerHeight),D=r(X.value*.8),z=r(),Y=()=>{C.value=window.innerWidth<992,q.value=window.innerWidth<768},F=r(!1),de=["Ben","Chris","David","Emma","Frank","Grace","Henry","Isabel","Jack","Kevin","Lucy","Michael","Nancy","Olivia","Paul","Quinn","Ryan","Sarah","Tom","Ursula","Victor","William","Xavier","Yvonne","Zoe"],I=r("private"),o=r({userId:"Alice",name:"Alice"}),M=r([{name:"Alice",selfId:p.uin,userId:"Alice"}]);ye([I,o],()=>{W()});const pe=(e,a)=>{if(e==="selectUser")return F.value=!0,!1},Z=()=>{const e=de.shift();if(!e){H("没有更多用户了",{type:"warning",customClass:"el"});return}M.value.push({name:e,selfId:p.uin,userId:e}),L.value[e]="user",v.value.private[e]=[]},J=r(),ee=()=>{Ce({title:"添加自定义用户",width:window.innerWidth<992?"90%":"50%",contentRenderer:()=>h(Ue,{ref:J}),beforeSure:async(e,{options:a,index:n,closeLoading:u})=>{await J.value.getRef().validate(_=>{if(_){const t=J.value.getData();M.value.some(x=>x.userId===t.userId)?H("用户已存在, 请更改用户id",{customClass:"el",type:"warning"}):(M.value.push({name:t.name,selfId:p.uin,userId:t.userId,avatar:t.avatar}),L.value[t.userId]="user",v.value.private[t.userId]=[],e())}else u()})},draggable:!0})},ae=r(0),L=r({Alice:"master"}),te=e=>{const a=M.value.find(n=>n.userId===e);o.value=a,N.value={sendType:ae.value,permission:L.value[e]||"user"}},v=r({private:{Alice:[]},group:[]}),K=r(null),w=r(""),ve=e=>{if(e.key==="Enter")if(e.preventDefault(),N.value.sendType===1&&e.ctrlKey||N.value.sendType===0&&!e.ctrlKey){if(!w.value.trim())return;P(w.value,!0)}else{const a=e.target,n=a.selectionStart,u=a.selectionEnd;w.value=w.value.substring(0,n)+`
`+w.value.substring(u),a.setSelectionRange(n,n)}},P=(e,a=!0)=>{const n=Me("sandbox.");if(E.value.send(JSON.stringify({type:"message",uin:p.uin,userId:o.value.userId,groupId:I.value==="group"?"sandbox.group":void 0,content:e,msgId:n,permission:L.value[o.value.userId]})),a){const u=I.value==="private"?v.value.private[o.value.userId]:v.value.group,i=e.replace(/\n|\r/g,"<br>").replace(/\s|\t/g,"&nbsp;");u.push({name:o.value.name,avatar:o.value.avatar,msgId:n,rawMessage:e,message:G({render(){return h("div",{class:"message",innerHTML:i,style:{maxWidth:`${z.value}px`}})}})}),w.value="",W()}},fe=e=>{e.rawMessage&&P(e.rawMessage,!0)},W=()=>{Le(()=>{const e=K.value.wrapRef.scrollHeight;K.value.setScrollTop(e)})},N=r({sendType:ae.value,permission:"master"}),me=[{label:"用户权限",prop:"permission",valueType:"radio",fieldProps:{onChange:e=>{L.value[o.value.userId]=e}},options:[{label:"群主",value:"owner"},{label:"管理员",value:"admin"},{label:"普通用户",value:"user"},{label:"主人",value:"master"}]},{label:"发送方式",prop:"sendType",valueType:"radio",options:[{label:"enter",value:0},{label:"ctrl+enter",value:1}]}],$=r(!0),E=r(null);ke(()=>{window.addEventListener("resize",Y),z.value=(O.value.$el.clientWidth-140-(C.value?60:200))*(C.value?1.1:.8),E.value=we("sandbox",{onopen(e){E.value.send(JSON.stringify({type:"create",uin:p.uin,nickname:p.nickname,avatar:p.avatar})),$.value=!1},onmessage(e){const a=JSON.parse(e.data),{type:n,id:u,content:i,msgId:_}=a,t=he(i,n==="friend"?"private":"group",u);if(t.length===0)return;const x={name:p.nickname,avatar:p.avatar,msgId:_,bot:!0,message:G({render(){return h("div",{class:"message",style:{maxWidth:`${z.value}px`}},t)}})};switch(n){case"friend":v.value.private[u].push(x);break;case"group":v.value.group.push(x);break}(n==="group"||u===o.value.userId)&&W()},onclose(){$.value||(H("连接已关闭",{type:"error",customClass:"el"}),$.value=!0)}})}),xe(()=>{var e,a;window.removeEventListener("resize",Y),$.value=!0,(a=(e=E.value).close)==null||a.call(e)});const ge=e=>{const a=e.bot?p.uin:e.name;(I.value==="private"?v.value.private[o.value.userId]:v.value.group).push({poke:{operatorId:o.value.name,targetId:e.name}}),E.value.send(JSON.stringify({type:"poke",uin:p.uin,groupId:I.value==="group"?"sandbox.group":void 0,userId:o.value.userId,operatorId:o.value.userId,targetId:a,permission:L.value[o.value.userId]})),W()},he=(e,a,n)=>{const u=a==="private"?v.value.private[n]:v.value.group,i=[],_=[];for(const t of e)switch(t.type){case"poke":return u.push({poke:{operatorId:p.nickname,targetId:t.qq}}),W(),[];case"at":i.push(h(ie,{type:"primary",underline:!1},`@${t.qq}`));break;case"reply":const x=u.find(y=>y.msgId===t.id);x&&i.push(h(x.message,{className:"bg-[#f2f2f2] rounded-lg px-2 h-[24px] overflow-hidden"}));break;case"text":i.push(h(Q,{innerHTML:t.text.replace(/\n|\r/g,"<br>").replace(/\s|\t/g,"&nbsp;"),tag:"b"}));break;case"image":if(t.file.startsWith("http")){const y=Date.now();t.file=t.file.includes("?")?t.file+`&t=${y}`:t.file+`?t=${y}`}i.push(h(We,{src:t.file,fit:"contain",previewSrcList:[t.file],style:"height: 400px"}));break;case"button":const b=[];for(const y of t.data){let R=Math.max(1,Math.min(5,y.length));for(const f of y){C.value&&b.length>=5&&(H(`手机端宽度限制,已将第${b.length+1}行中大于5个的按钮换到下一行`,{type:"warning",customClass:"el"}),R=Math.max(1,Math.min(5,y.length%5)),_.push(h("div",{class:"flex"},[...b])),b.length=0);const T={plain:!0,type:"primary"};switch(Number(f.style)){case 0:case 2:T.type="default";break;case 3:T.type="danger";break;case 4:T.plain=!1;break}b.push(h(ue,{style:`width: ${100/R}%;`,class:"mb-2 truncate text-ellipsis",icon:f.link?Te:void 0,...T,onClick:()=>{f.callback?P(f.callback,!1):f.input?w.value=f.input:f.link&&Ve(f.link)}},f.text))}b.length&&_.push(h("div",{class:"flex"},[...b])),b.length=0}break;default:i.push(h("div",{innerHTML:"[暂不支持本消息类型]"}))}return _.length&&i.push(..._),i};return(e,a)=>{const n=g("el-result"),u=g("el-aside"),i=g("el-avatar"),_=g("el-popover"),t=g("el-tab-pane"),x=g("el-tabs"),b=g("el-main"),y=g("el-input"),R=g("el-footer"),f=g("el-container"),T=g("el-drawer");return $.value?(d(),S(k(se),{key:0,ref_key:"cardRef",ref:O,class:"flex-c",style:le({height:`${D.value}px`})},{default:s(()=>[l(n,{icon:"info",title:"加载中..."})]),_:1},8,["style"])):(d(),S(k(se),{key:1,ref_key:"cardRef",ref:O,class:"p-0","body-style":"padding: 0;",style:le({height:`${D.value}px`})},{default:s(()=>[l(f,null,{default:s(()=>[q.value?U("",!0):(d(),S(u,{key:0,width:C.value?"60px":"200px"},{default:s(()=>[l(ce,{"is-collapse":C.value,addUser:Z,"add-custom-user":ee,userList:M.value,handleSelectMenu:te,height:D.value-140},null,8,["is-collapse","userList","height"])]),_:1},8,["width"])),l(f,null,{default:s(()=>[l(b,null,{default:s(()=>[o.value.userId?(d(),S(x,{key:0,modelValue:I.value,"onUpdate:modelValue":a[1]||(a[1]=c=>I.value=c),"before-leave":pe},{default:s(()=>[l(k(ne),{ref_key:"messageScrollbarRef",ref:K,height:`${D.value-180}px`},{default:s(()=>[(d(),V(oe,null,re([{name:"private",label:"私聊"},{name:"group",label:"群聊"}],c=>l(t,{key:c.name,label:c.label,name:c.name},{default:s(()=>[(d(!0),V(oe,null,re(c.name==="private"?v.value[c.name][o.value.userId]:v.value[c.name],m=>(d(),V("div",{key:m.msgId},[m.message?(d(),V("div",Re,[l(_,{trigger:"click"},{reference:s(()=>[l(i,{src:m.avatar,size:40,class:"mt-[5px]"},{default:s(()=>[A(B(m.name.slice(0,1)),1)]),_:2},1032,["src"])]),default:s(()=>[l(k(ie),{underline:!1,class:"w-full",onClick:_e=>ge(m)},{default:s(()=>[A(" 戳一戳 ")]),_:2},1032,["onClick"])]),_:2},1024),j("div",He,[j("div",null,[l(k(Q),{tag:"b"},{default:s(()=>[A(B(m.name),1)]),_:2},1024)]),j("div",Ae,[(d(),S(Ne(m.message))),m.bot?U("",!0):(d(),S(k(ue),{key:0,circle:"",type:"info",class:"ml-[10px]",onClick:_e=>fe(m)},{default:s(()=>[l(k($e),{icon:"mdi:plus-one",width:23,height:24})]),_:2},1032,["onClick"]))])])])):U("",!0),m.poke?(d(),V("div",Be,[l(k(Q),{class:"text-center"},{default:s(()=>[A(B(m.poke.operatorId)+" 戳了戳 "+B(m.poke.targetId),1)]),_:2},1024)])):U("",!0)]))),128))]),_:2},1032,["label","name"])),64)),l(t,{label:"设置",name:"setting"},{default:s(()=>[l(k(De),{modelValue:N.value,"onUpdate:modelValue":a[0]||(a[0]=c=>N.value=c),columns:me,"inline-message":"","label-position":"right",class:"mt-5",labelWidth:"100px","col-props":{span:13,lg:13,sm:24,xs:24},hasFooter:!1},null,8,["modelValue"])]),_:1}),q.value?(d(),S(t,{key:0,label:"切换用户",name:"selectUser"})):U("",!0)]),_:1},8,["height"])]),_:1},8,["modelValue"])):(d(),V("div",Oe,[l(n,{icon:"warning",title:"请选择用户","sub-title":"请在左侧选择用户"})]))]),_:1}),Ie(l(R,{height:"80px",class:"flex w-full items-center"},{default:s(()=>[l(k(ne),{style:{width:"100%"}},{default:s(()=>[l(y,{modelValue:w.value,"onUpdate:modelValue":a[2]||(a[2]=c=>w.value=c),type:"textarea",placeholder:"请输入消息内容",rows:3,resize:"none",onKeydown:ve},null,8,["modelValue"])]),_:1})]),_:1},512),[[Se,I.value!=="setting"&&o.value.userId]])]),_:1})]),_:1}),l(T,{modelValue:F.value,"onUpdate:modelValue":a[3]||(a[3]=c=>F.value=c),"with-header":!1,direction:"ltr",size:200},{default:s(()=>[l(ce,{"is-collapse":!1,addUser:Z,"add-custom-user":ee,userList:M.value,handleSelectMenu:te,height:X.value},null,8,["userList","height"])]),_:1},8,["modelValue"])]),_:1},8,["style"]))}}}),Ge=Ee(qe,[["__scopeId","data-v-b15a4061"]]);export{Ge as default};
